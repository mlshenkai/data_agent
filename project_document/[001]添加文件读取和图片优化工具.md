# [001] 添加文件读取和图片优化工具

**创建时间**: 2025-07-19 23:50:20 (Asia/Shanghai)  
**项目**: data_agent  
**状态**: 计划阶段  

## 任务概述

为data_agent项目添加两个新工具：
1. **文件读取工具** (`read_file`) - 支持多种文件格式的本地文件读取
2. **优化图片生成工具** (`optimized_fig_inter`) - 增强的图片生成和优化功能

## 技术方案

### 方案选择：创建新工具（推荐）
- **优势**: 保持向后兼容性，用户可以选择使用哪个工具
- **实现**: 在现有工具基础上添加新工具，不修改现有功能

## 详细实现计划

### 任务1: 创建文件读取工具

#### 功能特性
- 支持文件格式：CSV、Excel、JSON、Parquet、文本文件等
- 自动格式检测
- 参数配置支持
- 完善的错误处理
- 文件存在性检查

#### 实现步骤
1. **定义参数模型** `ReadFileSchema`
   ```python
   class ReadFileSchema(BaseModel):
       file_path: str = Field(description="文件路径")
       file_type: str = Field(description="文件类型（可选，自动检测）", default="auto")
       read_params: dict = Field(description="读取参数（可选）", default={})
       df_name: str = Field(description="保存的变量名")
   ```

2. **实现工具函数** `read_file`
   - 文件存在性检查
   - 格式自动检测逻辑
   - 根据格式调用相应的pandas读取函数
   - 错误处理和返回结果

3. **集成到工具列表**
   - 添加到tools列表中
   - 确保与其他工具的兼容性

### 任务2: 创建优化图片生成工具

#### 功能特性
- 图片质量控制（DPI、压缩率）
- 格式转换（PNG、JPG、SVG、PDF）
- 图片压缩优化
- 动态路径处理
- 自定义图片尺寸

#### 实现步骤
1. **定义参数模型** `OptimizedFigCodeInput`
   ```python
   class OptimizedFigCodeInput(BaseModel):
       py_code: str = Field(description="Python绘图代码")
       fname: str = Field(description="图片对象变量名")
       format: str = Field(description="输出格式", default="png")
       dpi: int = Field(description="图片分辨率", default=300)
       quality: int = Field(description="图片质量（JPG格式）", default=95)
       optimize: bool = Field(description="是否优化", default=True)
       figsize: tuple = Field(description="图片尺寸", default=None)
   ```

2. **实现工具函数** `optimized_fig_inter`
   - 动态路径处理（支持不同操作系统）
   - 图片质量控制
   - 格式转换功能
   - 错误处理和资源清理

3. **集成到工具列表**
   - 添加到tools列表中
   - 保持与现有fig_inter的兼容性

### 任务3: 更新提示词模板

#### 更新内容
1. **添加新工具使用说明**
   - 文件读取工具的使用场景和示例
   - 优化图片生成工具的优势和使用方法

2. **更新工具优先级说明**
   - 明确何时使用新工具
   - 与现有工具的选择指导

3. **提供具体示例**
   - 文件读取示例
   - 图片优化示例

## 技术实现要点

### 文件读取工具
- 使用pandas的多种读取函数
- 自动检测文件扩展名
- 支持常见文件格式的错误处理

### 图片优化工具
- 使用Pillow进行图片优化
- 支持多种matplotlib后端
- 动态路径处理
- 完善的错误处理

## 验证标准

### 文件读取工具验证
- [ ] 能够成功读取CSV文件
- [ ] 能够成功读取Excel文件
- [ ] 能够成功读取JSON文件
- [ ] 能够正确处理错误情况
- [ ] 自动格式检测功能正常

### 图片优化工具验证
- [ ] 能够生成高质量图片
- [ ] 支持多种格式转换
- [ ] 正确处理不同操作系统的路径
- [ ] 图片质量控制功能正常
- [ ] 错误处理完善

### 提示词模板验证
- [ ] AI助手能够正确选择和使用新工具
- [ ] 工具使用说明清晰准确
- [ ] 与现有工具说明保持一致

## 风险评估

### 低风险
- 新工具不影响现有功能
- 使用成熟的pandas和matplotlib库

### 中风险
- 路径处理可能在不同操作系统上有差异
- 图片格式转换可能遇到兼容性问题

### 缓解措施
- 充分测试不同操作系统的路径处理
- 提供多种图片格式的降级方案

## 时间估算

- **任务1**: 2-3小时
- **任务2**: 3-4小时  
- **任务3**: 1-2小时
- **总计**: 6-9小时

## 任务执行进度

### ✅ 任务1: 创建文件读取工具 - 已完成
**完成时间**: 2025-07-19 23:58:18  
**实现内容**:
- ✅ 定义ReadFileSchema参数模型
- ✅ 实现read_file工具函数
- ✅ 添加文件格式自动检测逻辑
- ✅ 集成到现有工具列表
- ✅ 更新提示词模板

**功能特性**:
- 支持CSV、Excel、JSON、Parquet、文本文件等格式
- 自动格式检测
- 参数配置支持
- 完善的错误处理
- 文件存在性检查

### ✅ 任务2: 创建优化图片生成工具 - 已完成
**完成时间**: 2025-07-20 00:05:59  
**实现内容**:
- ✅ 定义OptimizedFigCodeInput参数模型
- ✅ 实现optimized_fig_inter工具函数
- ✅ 添加图片质量控制和格式转换功能
- ✅ 实现动态路径处理
- ✅ 集成到工具列表

**功能特性**:
- 支持多种图片格式（PNG、JPG、SVG、PDF）
- 图片质量控制（DPI、压缩率）
- 图片压缩优化
- 动态路径处理（支持不同操作系统）
- 自定义图片尺寸

## 下一步行动

1. ✅ 任务1已完成
2. ✅ 任务2已完成
3. 开始执行任务3：更新提示词模板
4. 完成后进行验证测试
5. 最终集成测试和文档更新

---
**文档版本**: v1.1  
**最后更新**: 2025-07-19 23:58:18 